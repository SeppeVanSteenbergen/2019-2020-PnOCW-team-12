<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div>
    <label><input type="checkbox" id="checkboxCompare" onchange="firstCompare = this.checked">compareWithFirst</label><br/>
    <label><input type="text"  id="framerate" oninput="framerate = this.value"> frameWait</label><br/>
    <label><input type="text"  id="hold" oninput="hold = this.value"> threshold</label><br/>
    <label><input type="text"  id="confidence" oninput="confidence = this.value"> confidenceThreshold</label><br/>
    <button onclick="player = {x:200,y:200}">Reset Position</button>
</div>
<p id="out"></p>
    <canvas id="canv"></canvas>
<canvas style="border: 3px solid black" id="game"></canvas>
<video id="vid"></video>
</body>

<footer>
    <script src="/Fast.js"></script>
    <script src="/pageScript.js"></script>
    <script src="/tracking.js"></script>
    <script src="/Fast.js"></script>

    <script lang="text/javascript">

        // config

        let hold = 80 // threshold
        let framerate = 300 // ms wait time
        let own = false  // own implementatin of trackerjs
        let firstCompare = false  // only compare next frames with first, or compare with previous frame
        let confidence = 0.7 // how sure when matching keypoints


        let video = document.getElementById('vid')
        let canvas = document.getElementById('canv')
        let ctx = canvas.getContext('2d')

        document.getElementById('checkboxCompare').checked = firstCompare
        document.getElementById('framerate').value = framerate
        document.getElementById('hold').value = hold
        document.getElementById('confidence').value = confidence

        let game = document.getElementById('game')
        let ctg = game.getContext('2d')
        game.width = 400
        game.height = 400

        let player = {
          x:200,
          y:200
        }

        video.style.display = 'none'

        let previousDescriptor = null
        let previousCorners = null

        let matches = null
        let trans
        let out = document.getElementById('out')
      // Javascript
      navigator.mediaDevices.getUserMedia({
          video: true,
        audio:false
        }
      ).then(function(stream) {
        video.srcObject = stream;
        video.onloadedmetadata = function(e) {
          video.play();
          canvas.width = video.videoWidth
          canvas.height = video.videoHeight
          draw()
        };
      }).catch(function(err) {
        // deal with an error (such as no webcam)
      });



      video.addEventListener('play', function() {

      }, false);



        function draw() {
          tracking.Fast.THRESHOLD = hold
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          //own
          if(own) {
            let corners = FASTDetector(ctx.getImageData(0,0,canvas.width, canvas.height).data, canvas.width)
            console.log(corners)
            for (let i = 0; i < corners.length; i++) {
              ctx.fillStyle = '#f00';
              ctx.fillRect(corners[i][0], corners[i][1], 3, 3);
            }
          } else {
            let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let gray = tracking.Image.grayscale(imageData.data, canvas.width, canvas.height);
            let corners = tracking.Fast.findCorners(gray, canvas.width, canvas.height);

            trans = {
              x: 0,
              y: 0
            }

            let descriptor = tracking.Brief.getDescriptors(gray, canvas.width, corners);
            if(previousDescriptor !== null) {
              matches = tracking.Brief.reciprocalMatch(previousCorners, previousDescriptor, corners, descriptor);
                let selectedCount = 0
              for(let i = 0; i < matches.length; i++) {
                if(matches[i].confidence > confidence) {
                  selectedCount++
                  trans.x += matches[i].keypoint2[0] - matches[i].keypoint1[0]
                  trans.y += matches[i].keypoint2[1] - matches[i].keypoint1[1]
                }
              }
              if(selectedCount > 0) {
                trans.x = trans.x / selectedCount
                trans.y = trans.y / selectedCount
              }


              out.innerText = "x: " + trans.x + " y: " + trans.y
            }
            if(!firstCompare || previousDescriptor === null) {
              previousDescriptor = descriptor
              previousCorners = corners
            }

            //draw game
            if(firstCompare) {
              player.x = trans.x + 200
              player.y = trans.y + 200
            } else {
              player.x += trans.x
              player.y += trans.y
            }


            ctg.clearRect(0, 0, game.width, game.height)
            ctg.fillStyle = '#f00';
            ctg.fillRect(player.x, player.y, 20, 20);


            for (let i = 0; i < corners.length; i += 2) {
              ctx.fillStyle = '#f00';
              ctx.fillRect(corners[i], corners[i + 1], 3, 3);
            }
          }

          setTimeout(draw, framerate);
        }
    </script>
</footer>
</html>